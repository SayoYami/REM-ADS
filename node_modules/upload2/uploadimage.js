const axios = require('axios');
const FormData = require('form-data');
const fs = require('fs');
const path = require('path');

async function upload2(image) {
    let form = new FormData();

    console.log('Tipo de image:', typeof image); // Adiciona log para verificar o tipo de image

    if (fs.existsSync(image)) {
        // Se a imagem for um caminho de arquivo
        form.append('image', fs.createReadStream(image));
    } else if (typeof image === 'string' && image.startsWith('data:image/')) {
        // Se a imagem for uma string base64
        const base64Data = image.replace(/^data:image\/\w+;base64,/, '');
        const buffer = Buffer.from(base64Data, 'base64');
        const tempFilePath = path.join(__dirname, 'temp_image.jpg');
        fs.writeFileSync(tempFilePath, buffer);
        form.append('image', fs.createReadStream(tempFilePath));
    } else {
        throw new Error('O parâmetro fornecido não é um caminho de arquivo válido ou uma string base64.');
    }

    try {
        const response = await axios.post('http://nxf-01.nexfuture.com.br:25578/upload', form, {
            headers: {
                ...form.getHeaders()
            }
        });

        if (response.data && response.data.status) {
            return response.data.imageUrl;
        } else {
            throw new Error('Erro ao carregar a imagem.');
        }
    } catch (error) {
        throw new Error(`Erro: ${error.message}`);
    } finally {
        // Remove o arquivo temporário se ele foi criado
        const tempFilePath = path.join(__dirname, 'temp_image.jpg');
        if (fs.existsSync(tempFilePath)) {
            fs.unlinkSync(tempFilePath);
        }
    }
}

module.exports = upload2;
